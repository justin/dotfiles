# load ssh keys in the current shell
function loadsshkeys() {
eval `ssh-agent`
{{ if eq .osid "darwin" -}}
fd -t f -E '*.pub' -g 'id*' ~/.ssh -X ssh-add --apple-use-keychain
{{ else if and (eq .chezmoi.os "linux") (not .ephemeral) (not .synology) -}}
fd -t f -E '*.pub' -g 'id*' ~/.ssh -X ssh-add
{{ end -}}
}

# Check if the ssh agent should be running but is dead
#
# For example: after a 'stupid' `pkill ssh`, the env var SSH_AGENT_PID will still
# exist, the target pid does not exist anymore thanks to pkill.
if [[ -n "$SSH_AGENT_PID" ]] && ! kill -0 "$SSH_AGENT_PID" >& /dev/null; then
  warning "The ssh agent should be running but is dead, reloading ssh keys!"
  loadsshkeys >& /dev/null
fi
