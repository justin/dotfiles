{{- if and (eq .osid "darwin") (not .headless) -}}
#!/usr/bin/env zsh
# @file run_onchange_before_10-homebrew-packages.sh
# Install Homebrew packages, casks, taps, and MAS apps as defined in .chezmoidata/macos.yml
#
set -euo pipefail

source "$XDG_DATA_HOME/chezmoi/files/functions/_logging"
source "$XDG_DATA_HOME/chezmoi/files/functions/_utilities"

had_error=0

# --- TAPS ---
taps=(
  {{- range $tap := .packages.homebrew.global.taps }}
  "{{ $tap }}"
  {{- end }}
  {{- range $tap := .packages.homebrew.personal.taps }}
  "{{ $tap }}"
  {{- end }}
  {{- range $tap := .packages.homebrew.work.taps }}
  "{{ $tap }}"
  {{- end }}
)
for tap in "${taps[@]}"; do
  if ! brew tap | grep -q "^${tap}$"; then
    if brew tap "$tap"; then
      success "Tapped $tap"
    else
      warning "Failed to tap $tap"
      had_error=1
    fi
  fi
done

# --- BREWS ---
brews=(
  {{- range $brew := .packages.homebrew.global.brews }}
  "{{ $brew }}"
  {{- end }}
  {{- range $brew := .packages.homebrew.personal.brews }}
  "{{ $brew }}"
  {{- end }}
  {{- range $brew := .packages.homebrew.work.brews }}
  "{{ $brew }}"
  {{- end }}
)

processing "Installing missing Homebrew packages..."
for brew_pkg in "${brews[@]}"; do
  if ! brew list --formula "$brew_pkg" &>/dev/null; then
    info "Installing brew $brew_pkg"
    if brew install "$brew_pkg"; then
      success "Installed $brew_pkg"
    else
      warning "Failed to install $brew_pkg"
      had_error=1
    fi
  fi
done

# --- CASKS ---
processing "Installing missing Homebrew casks..."
casks=(
  {{- range $cask := .packages.homebrew.global.casks }}
  "{{ $cask }}"
  {{- end }}
  {{- range $cask := .packages.homebrew.personal.casks }}
  "{{ $cask }}"
  {{- end }}
  {{- range $cask := .packages.homebrew.work.casks }}
  "{{ $cask }}"
  {{- end }}
)
for cask_pkg in "${casks[@]}"; do
  if ! brew list --cask "$cask_pkg" &>/dev/null; then
    info "Installing cask $cask_pkg"
    if brew install --cask "$cask_pkg"; then
      success "Installed cask $cask_pkg"
    else
      warning "Failed to install cask $cask_pkg"
      had_error=1
    fi
  fi
done

# --- MAS APPS ---
processing "Installing missing Mac App Store apps..."
mas_ids=(
  {{- range $app := .packages.homebrew.global.mas }}
  {{ $app.id }}
  {{- end }}
  {{- range $app := .packages.homebrew.personal.mas }}
  {{ $app.id }}
  {{- end }}
  {{- range $app := .packages.homebrew.work.mas }}
  {{ $app.id }}
  {{- end }}
)
for mas_id in "${mas_ids[@]}"; do
  if ! mas list | awk '{print $1}' | grep -q "^${mas_id}$"; then
    info "Installing MAS app $mas_id"
    if mas install "$mas_id"; then
      success "Installed MAS app $mas_id"
    else
      warning "Failed to install MAS app $mas_id"
      had_error=1
    fi
  fi
done

if (( had_error )); then
  warning "Homebrew and MAS package installation completed with errors"
  exit 1
else
  success "Homebrew and MAS package installation complete"
  exit 0
fi
{{- end }}
